<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Interaction Replay — GameTape</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0f172a;
  --surface: #1e293b;
  --surface2: #273549;
  --border: #334155;
  --text: #f1f5f9;
  --text2: #94a3b8;
  --accent: #3b82f6;
  --glow: rgba(59, 130, 246, 0.4);
}

body {
  font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* --- Header --- */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  flex-shrink: 0;
  gap: 16px;
}
header h1 {
  font-size: 15px;
  font-weight: 600;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text2);
  white-space: nowrap;
}
header h1 span { color: var(--accent); }
#session-info {
  font-size: 11px;
  color: var(--text2);
  white-space: nowrap;
}
#transcript-select {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 12px;
  font-family: inherit;
  font-size: 12px;
  max-width: 500px;
  flex: 1;
  cursor: pointer;
}

/* --- Main Layout --- */
main {
  display: flex;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

/* --- Arena --- */
#arena-wrap {
  flex: 1;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
#arena-canvas {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
}
.agent-node {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  transform: translate(-50%, -50%);
  transition: opacity 0.3s, filter 0.3s;
  z-index: 2;
}
.agent-node.inactive { opacity: 0.25; filter: grayscale(0.8); }
.agent-avatar {
  width: 60px; height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 3px solid transparent;
  transition: border-color 0.3s, box-shadow 0.3s;
  position: relative;
  overflow: hidden;
}
.agent-avatar svg {
  width: 34px; height: 34px;
}
.agent-node.sender .agent-avatar {
  box-shadow: 0 0 20px var(--agent-color), 0 0 40px var(--agent-color);
  border-color: #fff;
}
.agent-node.receiver .agent-avatar {
  box-shadow: 0 0 14px var(--agent-color);
  border-color: var(--agent-color);
}
.agent-label {
  font-size: 10px;
  color: var(--text2);
  text-align: center;
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.agent-role {
  font-size: 9px;
  color: var(--text2);
  opacity: 0.6;
  text-align: center;
  white-space: nowrap;
}

/* --- Speech Bubble --- */
#speech-bubble {
  position: absolute;
  max-width: 280px;
  padding: 10px 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 12px;
  line-height: 1.5;
  color: var(--text);
  opacity: 0;
  transform: translate(-50%, -50%) scale(0.9);
  transition: opacity 0.25s, transform 0.25s;
  pointer-events: none;
  z-index: 10;
  box-shadow: 0 4px 24px rgba(0,0,0,0.5);
}
#speech-bubble.visible {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}
#speech-bubble .bubble-from {
  font-size: 10px;
  font-weight: 600;
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
#speech-bubble .bubble-text {
  color: var(--text2);
  word-break: break-word;
  max-height: 120px;
  overflow: hidden;
}

/* --- Drop Zone --- */
#drop-zone {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  z-index: 5;
  background: rgba(15, 23, 42, 0.92);
  border: 2px dashed var(--border);
  border-radius: 12px;
  margin: 20px;
}
#drop-zone.hidden { display: none; }
#drop-zone p { color: var(--text2); font-size: 14px; }
#drop-zone .hint { font-size: 11px; color: var(--text2); opacity: 0.6; }
#drop-zone.dragover { border-color: var(--accent); background: rgba(59,130,246,0.08); }
#file-input { display: none; }
#drop-zone button {
  padding: 8px 20px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 6px;
  font-family: inherit;
  font-size: 12px;
  cursor: pointer;
}

/* --- Side Panel --- */
#panel {
  width: 340px;
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  background: var(--surface);
  flex-shrink: 0;
}
#msg-detail {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
#msg-detail .detail-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
#msg-detail .detail-counter {
  font-size: 11px;
  color: var(--text2);
}
#msg-detail .detail-time {
  font-size: 11px;
  color: var(--accent);
  font-weight: 600;
}
#msg-detail .detail-route {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
}
#msg-detail .detail-route .arrow { color: var(--text2); margin: 0 6px; }
#msg-detail .detail-type {
  display: inline-block;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 2px 8px;
  border-radius: 4px;
  margin-bottom: 10px;
  font-weight: 600;
}
#msg-detail .detail-content {
  font-size: 12px;
  line-height: 1.6;
  color: var(--text2);
  max-height: 200px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-word;
}
#msg-detail .detail-content::-webkit-scrollbar { width: 4px; }
#msg-detail .detail-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* --- Message List --- */
#msg-list-wrap {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}
#msg-list-wrap::-webkit-scrollbar { width: 6px; }
#msg-list-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.msg-item {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  padding: 8px 16px;
  cursor: pointer;
  border-bottom: 1px solid rgba(51,65,85,0.3);
  transition: background 0.15s;
  font-size: 11px;
}
.msg-item:hover { background: var(--surface2); }
.msg-item.active { background: rgba(59,130,246,0.12); border-left: 2px solid var(--accent); }
.msg-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
  margin-top: 4px;
}
.msg-item-route { font-weight: 600; white-space: nowrap; }
.msg-item-time { color: var(--text2); margin-left: auto; white-space: nowrap; flex-shrink: 0; }
.msg-item-summary {
  color: var(--text2);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
  min-width: 0;
}
.msg-self-badge {
  font-size: 8px;
  background: rgba(99,102,241,0.2);
  color: #a5b4fc;
  padding: 1px 5px;
  border-radius: 3px;
  margin-left: 4px;
  flex-shrink: 0;
}

/* --- Controls --- */
footer {
  border-top: 1px solid var(--border);
  background: var(--surface);
  padding: 10px 20px;
  flex-shrink: 0;
}
#timeline {
  width: 100%;
  height: 6px;
  background: var(--surface2);
  border-radius: 3px;
  cursor: pointer;
  margin-bottom: 10px;
  position: relative;
}
#timeline-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 3px;
  transition: width 0.15s;
}
#timeline-thumb {
  position: absolute;
  top: 50%;
  width: 14px; height: 14px;
  background: #fff;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 1px 4px rgba(0,0,0,0.4);
  transition: left 0.15s;
}
#controls {
  display: flex;
  align-items: center;
  gap: 12px;
}
#controls button {
  background: none;
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 6px;
  padding: 6px 14px;
  font-family: inherit;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
}
#controls button:hover { background: var(--surface2); border-color: var(--text2); }
#controls button.playing { background: var(--accent); border-color: var(--accent); }
#counter-label {
  font-size: 12px;
  color: var(--text2);
  min-width: 80px;
  text-align: center;
}
.speed-control {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: auto;
  font-size: 11px;
  color: var(--text2);
}
.speed-control input[type=range] {
  width: 100px;
  accent-color: var(--accent);
}
#speed-label { min-width: 32px; text-align: right; font-weight: 600; color: var(--text); }

/* --- Empty State --- */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text2);
  font-size: 13px;
  gap: 8px;
}
.empty-state .big { font-size: 36px; opacity: 0.3; margin-bottom: 8px; }

/* --- Tab Navigation --- */
.nav-tabs {
  display: flex;
  gap: 2px;
  background: var(--bg);
  border-radius: 8px;
  padding: 2px;
}
.nav-tab {
  padding: 6px 16px;
  font-family: inherit;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text2);
  background: none;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
  white-space: nowrap;
}
.nav-tab:hover { background: var(--surface2); color: var(--text); }
.nav-tab.active { background: var(--accent); color: #fff; }

/* --- View containers --- */
.view-hidden { display: none !important; }

/* --- Retros View --- */
#retros-view {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
  overflow: hidden;
}
.retros-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  gap: 10px;
  flex-wrap: wrap;
}
.retros-header h2 {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  white-space: nowrap;
}
.retro-session-select {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 12px;
  font-family: inherit;
  font-size: 12px;
  max-width: 400px;
  flex: 1;
  min-width: 140px;
  cursor: pointer;
}
.retro-count {
  font-size: 10px;
  opacity: 0.7;
  font-weight: 400;
  white-space: nowrap;
}

/* --- Working Agreement View --- */
#agreement-view {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
  overflow: hidden;
}
.agreement-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  gap: 10px;
  flex-wrap: wrap;
}
.agreement-header h2 {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  white-space: nowrap;
}
.agreement-header-actions {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}
#agreement-info {
  font-size: 10px;
  color: var(--text2);
  white-space: nowrap;
}
.agreement-header-actions button {
  padding: 6px 14px;
  border-radius: 6px;
  font-family: inherit;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border);
  background: none;
  color: var(--text2);
  transition: background 0.15s, color 0.15s;
}
.agreement-header-actions button:hover { background: var(--surface2); color: var(--text); }
.agreement-header-actions button.primary {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}
.agreement-header-actions button.primary:hover { background: #2563eb; }

.agreement-body {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  min-height: 0;
}
.agreement-body::-webkit-scrollbar { width: 6px; }
.agreement-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.agreement-section {
  margin-bottom: 28px;
}
.agreement-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.agreement-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}
.agreement-section-count {
  font-size: 10px;
  color: var(--text2);
}
.agreement-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 12px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 8px;
  transition: border-color 0.15s;
}
.agreement-item:hover { border-color: var(--text2); }
.agreement-item-header {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  user-select: none;
}
.agreement-item-header .collapse-icon {
  font-size: 9px;
  color: var(--text2);
  transition: transform 0.2s;
  flex-shrink: 0;
  width: 14px;
  text-align: center;
}
.agreement-item.collapsed .collapse-icon { transform: rotate(-90deg); }
.agreement-item.collapsed .agreement-item-detail,
.agreement-item.collapsed .agreement-item-updates { display: none; }
.agreement-item-icon {
  font-size: 14px;
  flex-shrink: 0;
  width: 24px;
  text-align: center;
  margin-top: 1px;
}
.agreement-item-content {
  flex: 1;
  min-width: 0;
}
.agreement-item-text {
  font-size: 12px;
  line-height: 1.6;
  color: var(--text);
  white-space: pre-wrap;
  word-break: break-word;
}
.agreement-item-detail {
  font-size: 11px;
  color: var(--text2);
  margin-top: 4px;
  line-height: 1.5;
}
.agreement-item-actions {
  display: flex;
  gap: 6px;
  flex-shrink: 0;
  opacity: 0;
  transition: opacity 0.15s;
}
.agreement-item:hover .agreement-item-actions { opacity: 1; }
.agreement-item-actions button {
  background: none;
  border: none;
  color: var(--text2);
  font-family: inherit;
  font-size: 10px;
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 3px;
  transition: color 0.15s, background 0.15s;
}
.agreement-item-actions button:hover { color: var(--text); background: var(--surface); }
.agreement-item-actions button.delete:hover { color: #EF4444; }

.agreement-add-btn {
  background: none;
  border: 1px dashed var(--border);
  border-radius: 6px;
  padding: 10px 14px;
  color: var(--text2);
  font-family: inherit;
  font-size: 12px;
  cursor: pointer;
  transition: border-color 0.15s, color 0.15s;
  text-align: left;
  width: 100%;
  margin-top: 4px;
}
.agreement-add-btn:hover { border-color: var(--text2); color: var(--text); }

/* Agreement input dialog */
.agreement-input-dialog {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  width: 520px;
  max-width: 90vw;
  box-shadow: 0 8px 40px rgba(0,0,0,0.5);
}
.agreement-input-dialog h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--text);
}
.agreement-input-dialog label {
  display: block;
  font-size: 11px;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
  margin-top: 12px;
}
.agreement-input-dialog label:first-of-type { margin-top: 0; }
.agreement-input-dialog input,
.agreement-input-dialog textarea,
.agreement-input-dialog select {
  width: 100%;
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 8px 12px;
  font-family: inherit;
  font-size: 12px;
}
.agreement-input-dialog textarea {
  min-height: 60px;
  line-height: 1.6;
  resize: vertical;
}
.agreement-input-dialog input:focus,
.agreement-input-dialog textarea:focus,
.agreement-input-dialog select:focus { outline: none; border-color: var(--accent); }
.agreement-input-dialog .dialog-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 16px;
}
.agreement-input-dialog .dialog-buttons button {
  padding: 8px 18px;
  border-radius: 6px;
  font-family: inherit;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border);
  transition: background 0.15s;
}
.agreement-input-dialog .dialog-buttons .btn-cancel {
  background: none;
  color: var(--text2);
}
.agreement-input-dialog .dialog-buttons .btn-cancel:hover { background: var(--surface2); }
.agreement-input-dialog .dialog-buttons .btn-save {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}
.agreement-input-dialog .dialog-buttons .btn-save:hover { background: #2563eb; }

.agreement-last-updated {
  font-size: 10px;
  color: var(--text2);
  margin-top: 24px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
  text-align: center;
}

/* --- Retro Entries --- */
.retros-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-height: 0;
  -webkit-overflow-scrolling: touch;
}
.retros-body::-webkit-scrollbar { width: 6px; }
.retros-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.retro-entry {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}
.retro-entry-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  cursor: pointer;
  user-select: none;
  transition: background 0.15s;
}
.retro-entry-header:hover { background: var(--surface2); }
.retro-entry-header .collapse-icon {
  font-size: 10px;
  color: var(--text2);
  transition: transform 0.2s;
  flex-shrink: 0;
  width: 16px;
  text-align: center;
}
.retro-entry.collapsed .collapse-icon { transform: rotate(-90deg); }
.retro-entry.collapsed .retro-entry-sections { display: none; }
.retro-entry.collapsed .retro-entry-header { border-bottom: none; }
.retro-entry-badge {
  font-size: 8px;
  font-weight: 700;
  letter-spacing: 0.8px;
  padding: 3px 8px;
  border-radius: 4px;
  flex-shrink: 0;
  text-transform: uppercase;
}
.retro-entry-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
}
.retro-entry-meta-count {
  font-size: 10px;
  color: var(--text2);
  flex-shrink: 0;
  opacity: 0.6;
}
.retro-entry-commit {
  font-size: 10px;
  color: var(--text2);
  flex-shrink: 0;
}
.retro-entry-commit code {
  background: var(--surface2);
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 10px;
  margin-right: 3px;
}
.retro-entry-sections {
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.retro-section {
  border-radius: 8px;
  padding: 12px 14px;
  border-left: 3px solid var(--border);
}
.retro-section-positive { border-left-color: #10B981; background: rgba(16, 185, 129, 0.06); }
.retro-section-negative { border-left-color: #EF4444; background: rgba(239, 68, 68, 0.06); }
.retro-section-action { border-left-color: #3B82F6; background: rgba(59, 130, 246, 0.06); }
.retro-section-stats { border-left-color: #8B5CF6; background: rgba(139, 92, 246, 0.06); }
.retro-section-question { border-left-color: #F59E0B; background: rgba(245, 158, 11, 0.06); }
.retro-section-neutral { background: rgba(39, 53, 73, 0.5); }
.retro-section-title {
  font-size: 11px;
  font-weight: 600;
  color: var(--text);
  text-transform: uppercase;
  letter-spacing: 0.6px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.retro-section-title::before {
  display: inline-block;
  font-size: 12px;
  flex-shrink: 0;
}
.retro-section-positive .retro-section-title::before { content: '\2714'; color: #10B981; }
.retro-section-negative .retro-section-title::before { content: '\2718'; color: #EF4444; }
.retro-section-action .retro-section-title::before { content: '\25B6'; color: #3B82F6; }
.retro-section-stats .retro-section-title::before { content: '\25A0'; color: #8B5CF6; }
.retro-section-question .retro-section-title::before { content: '?'; color: #F59E0B; font-weight: 700; }
.retro-section-neutral .retro-section-title::before { content: '\25CB'; color: var(--text2); }

.retro-section-content {
  font-size: 12px;
  line-height: 1.7;
  color: var(--text2);
}
.retro-section-content strong { color: var(--text); }
.retro-section-content code {
  background: var(--bg);
  padding: 1px 5px;
  border-radius: 3px;
  font-size: 11px;
  color: var(--accent);
  word-break: break-all;
}
.retro-section-content em { color: var(--text); font-style: italic; }
.retro-section-content p { margin: 4px 0; }
.retro-section-content p:empty { display: none; }

/* Retro markdown rendering */
.retro-table-wrap {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin: 8px 0;
  border-radius: 6px;
  border: 1px solid var(--border);
}
.retro-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
  min-width: 320px;
}
.retro-table th {
  background: var(--bg);
  padding: 7px 10px;
  text-align: left;
  font-weight: 600;
  color: var(--text);
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.retro-table td {
  padding: 6px 10px;
  border-bottom: 1px solid rgba(51,65,85,0.3);
  color: var(--text2);
}
.retro-table td strong { color: var(--text); }
.retro-table tr:last-child td { border-bottom: none; }
.retro-table tr:hover td { background: rgba(59,130,246,0.04); }

.retro-checkbox {
  padding: 5px 0 5px 26px;
  position: relative;
  line-height: 1.5;
}
.retro-checkbox::before {
  content: '';
  position: absolute;
  left: 2px;
  top: 7px;
  width: 14px;
  height: 14px;
  border: 1.5px solid var(--border);
  border-radius: 3px;
}
.retro-checkbox.checked::before {
  background: #10B981;
  border-color: #10B981;
}
.retro-checkbox.checked::after {
  content: '\2713';
  position: absolute;
  left: 5px;
  top: 5px;
  color: #fff;
  font-size: 11px;
  font-weight: 700;
}
.retro-checkbox.unchecked::before {
  border-color: var(--text2);
}
.retro-checkbox.partial::before {
  background: #F59E0B44;
  border-color: #F59E0B;
}
.retro-checkbox.partial::after {
  content: '~';
  position: absolute;
  left: 6px;
  top: 4px;
  color: #F59E0B;
  font-size: 12px;
  font-weight: 700;
}

.retro-list-item {
  padding: 4px 0;
  line-height: 1.6;
}
.retro-list-num {
  color: var(--accent);
  font-weight: 600;
  margin-right: 4px;
}
.retro-bullet {
  padding: 3px 0 3px 16px;
  position: relative;
  line-height: 1.6;
}
.retro-bullet::before {
  content: '\2022';
  position: absolute;
  left: 3px;
  color: var(--text2);
}
.retro-bullet.retro-indent {
  padding-left: 30px;
}
.retro-bullet.retro-indent::before { left: 16px; }
.retro-bullet.retro-indent2 {
  padding-left: 44px;
}
.retro-bullet.retro-indent2::before { left: 30px; }
.retro-code {
  background: var(--bg);
  padding: 10px 14px;
  border-radius: 6px;
  font-size: 11px;
  line-height: 1.5;
  overflow-x: auto;
  margin: 8px 0;
  white-space: pre-wrap;
  word-break: break-word;
}

/* --- Agreement Updates Tags --- */
.agreement-item-updates {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-top: 10px;
}
.agreement-update-tag {
  font-size: 9px;
  padding: 2px 8px;
  border-radius: 10px;
  background: rgba(59, 130, 246, 0.12);
  color: var(--accent);
  font-weight: 600;
  letter-spacing: 0.3px;
}

/* --- Agreement Version Note --- */
.agreement-version-note {
  background: rgba(245, 158, 11, 0.1);
  border: 1px solid rgba(245, 158, 11, 0.3);
  border-radius: 8px;
  padding: 12px 16px;
  font-size: 12px;
  color: #F59E0B;
  margin-bottom: 16px;
}
.agreement-version-note strong { color: #FBBF24; }
.agreement-version-note code {
  background: rgba(245, 158, 11, 0.15);
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 11px;
}

/* --- Git Timeline --- */
.agreement-git-timeline {
  margin-top: 24px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
}
.git-timeline-entry {
  display: flex;
  gap: 12px;
  position: relative;
  padding-bottom: 14px;
}
.git-timeline-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--border);
  flex-shrink: 0;
  margin-top: 4px;
  z-index: 1;
}
.git-timeline-entry.active .git-timeline-dot {
  background: var(--accent);
  box-shadow: 0 0 8px var(--glow);
}
.git-timeline-line {
  position: absolute;
  left: 4px;
  top: 14px;
  bottom: 0;
  width: 2px;
  background: var(--border);
}
.git-timeline-line.last { display: none; }
.git-timeline-content {
  flex: 1;
  min-width: 0;
}
.git-timeline-date {
  font-size: 10px;
  color: var(--accent);
  font-weight: 600;
  margin-bottom: 2px;
}
.git-timeline-msg {
  font-size: 12px;
  color: var(--text);
  line-height: 1.4;
  word-break: break-word;
}
.git-timeline-sha { margin-top: 2px; }
.git-timeline-sha code {
  font-size: 10px;
  color: var(--text2);
  background: var(--surface2);
  padding: 1px 6px;
  border-radius: 3px;
}

/* --- Agreement body content styles --- */
.agreement-body {
  padding: 16px;
}
.agreement-body::-webkit-scrollbar { width: 6px; }
.agreement-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.agreement-body .agreement-item-detail {
  max-height: none;
}
.agreement-body .agreement-item-detail p { margin: 3px 0; }
.agreement-body .agreement-item-detail p:empty { display: none; }
.agreement-body .agreement-item-detail strong { color: var(--text); }
.agreement-body .agreement-item-detail code {
  background: var(--bg);
  padding: 1px 5px;
  border-radius: 3px;
  font-size: 11px;
  color: var(--accent);
  word-break: break-all;
}
.agreement-body .retro-bullet {
  padding: 2px 0 2px 16px;
  position: relative;
  font-size: 12px;
  line-height: 1.6;
  color: var(--text2);
}
.agreement-body .retro-table-wrap {
  margin: 6px 0;
}

/* --- Mobile Responsive --- */
@media (max-width: 768px) {
  header {
    flex-wrap: wrap;
    padding: 10px 12px;
    gap: 8px;
  }
  header h1 { font-size: 13px; }
  .nav-tabs { order: -1; width: 100%; justify-content: center; }
  .nav-tab { padding: 6px 12px; font-size: 10px; }
  #transcript-select {
    max-width: none;
    font-size: 11px;
    min-width: 0;
  }
  #session-info {
    display: none;
  }

  .retros-header {
    padding: 10px 12px;
    gap: 8px;
  }
  .retros-header h2 { font-size: 13px; }
  .retros-body { padding: 10px; gap: 12px; }

  .retro-entry-header { padding: 12px; gap: 8px; }
  .retro-entry-title { font-size: 12px; }
  .retro-entry-badge { font-size: 7px; padding: 2px 6px; }
  .retro-entry-commit { display: none; }
  .retro-entry-sections { padding: 10px 12px; gap: 8px; }
  .retro-section { padding: 10px 12px; }
  .retro-section-title { font-size: 10px; margin-bottom: 6px; }
  .retro-section-content { font-size: 11px; line-height: 1.6; }
  .retro-table { font-size: 10px; }
  .retro-table th, .retro-table td { padding: 4px 6px; }
  .retro-list-item { font-size: 11px; }
  .retro-bullet { font-size: 11px; }

  .agreement-header { flex-wrap: wrap; padding: 10px 12px; }
  .agreement-header h2 { font-size: 13px; }
  .agreement-body { padding: 10px; }
  .agreement-item { padding: 10px 12px; gap: 8px; }
  .agreement-item-icon { font-size: 12px; width: 20px; }
  .agreement-item-text { font-size: 11px; }
  .agreement-item-detail { font-size: 11px; }

  .git-timeline-msg { font-size: 11px; }

  /* Stack arena and panel vertically on mobile */
  main {
    flex-direction: column;
  }
  #arena-wrap {
    min-height: 200px;
    flex: 1;
  }
  #panel {
    width: 100%;
    max-height: 35vh;
    border-left: none;
    border-top: 1px solid var(--border);
  }
  #msg-detail .detail-content {
    max-height: 80px;
  }

  footer { padding: 8px 12px; }
  #controls {
    flex-wrap: wrap;
    gap: 8px;
  }
  .speed-control {
    margin-left: 0;
    width: 100%;
    justify-content: flex-start;
  }
  .speed-control input[type=range] {
    flex: 1;
    min-width: 0;
  }

  .retro-session-select { font-size: 11px; }
}

@media (max-width: 480px) {
  header h1 { font-size: 12px; }
  .nav-tab { padding: 5px 10px; font-size: 9px; letter-spacing: 0.5px; }

  #panel {
    max-height: 30vh;
  }
  #controls button {
    padding: 6px 10px;
    font-size: 12px;
  }
  #counter-label {
    min-width: auto;
    font-size: 11px;
  }

  .retros-body { padding: 8px; gap: 10px; }
  .retro-entry-header { padding: 10px; }
  .retro-entry-title { font-size: 11px; }
  .retro-entry-sections { padding: 8px 10px; gap: 6px; }
  .retro-section { padding: 8px 10px; border-left-width: 2px; }
  .retro-section-title { font-size: 9px; }
  .retro-section-content { font-size: 10px; }

  .agreement-body { padding: 8px; }
  .agreement-item { padding: 8px 10px; }
}
</style>
</head>
<body>

<header>
  <h1><span>GameTape</span></h1>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchView('replay')">Replay</button>
    <button class="nav-tab" onclick="switchView('retros')">Retros</button>
    <button class="nav-tab" onclick="switchView('agreement')">Working Agreement</button>
  </div>
  <select id="transcript-select"><option value="">-- Loading... --</option></select>
  <span id="session-info"></span>
</header>

<!-- ═══ Replay View ═══ -->
<main id="replay-view">
  <div id="arena-wrap">
    <canvas id="arena-canvas"></canvas>
    <div id="speech-bubble">
      <div class="bubble-from"></div>
      <div class="bubble-text"></div>
    </div>
    <div id="drop-zone" class="hidden">
      <p>Drop transcript .md files here</p>
      <button onclick="document.getElementById('file-input').click()">Browse Files</button>
      <input type="file" id="file-input" multiple accept=".md,.json">
      <span class="hint">Or drag transcript .md files from your machine</span>
    </div>
  </div>

  <div id="panel">
    <div id="msg-detail">
      <div class="detail-header">
        <span class="detail-counter" id="detail-counter">No messages</span>
        <span class="detail-time" id="detail-time"></span>
      </div>
      <div class="detail-route" id="detail-route"></div>
      <div class="detail-type" id="detail-type"></div>
      <div class="detail-content" id="detail-content">Select a session to begin.</div>
    </div>
    <div id="msg-list-wrap"></div>
  </div>
</main>

<footer id="replay-footer">
  <div id="timeline" onclick="handleTimelineClick(event)">
    <div id="timeline-fill"></div>
    <div id="timeline-thumb"></div>
  </div>
  <div id="controls">
    <button id="btn-prev" onclick="stepPrev()" title="Previous message">&lt;</button>
    <button id="btn-play" onclick="togglePlay()" title="Play / Pause">Play</button>
    <button id="btn-next" onclick="stepNext()" title="Next message">&gt;</button>
    <span id="counter-label">0 / 0</span>
    <div class="speed-control">
      <span>Speed</span>
      <input type="range" id="speed-slider" min="0.25" max="4" step="0.25" value="1" oninput="updateSpeed()">
      <span id="speed-label">1x</span>
    </div>
  </div>
</footer>

<!-- ═══ Retros View ═══ -->
<div id="retros-view" class="view-hidden">
  <div class="retros-header">
    <h2>Sprint Retrospectives</h2>
    <select id="retro-sprint-select" class="retro-session-select">
      <option value="all">All Sprints</option>
    </select>
    <span id="retro-info" class="retro-count"></span>
  </div>
  <div class="retros-body" id="retros-body">
    <div class="empty-state">
      <div class="big">&#8635;</div>
      <p>Loading retrospectives...</p>
    </div>
  </div>
</div>

<!-- ═══ Working Agreement View ═══ -->
<div id="agreement-view" class="view-hidden">
  <div class="agreement-header">
    <h2>Team Working Agreements</h2>
    <div class="agreement-header-actions">
      <select id="agreement-version-select" class="retro-session-select">
        <option value="latest">Latest Version</option>
      </select>
      <span id="agreement-info"></span>
    </div>
  </div>
  <div class="agreement-body" id="agreement-body">
    <div class="empty-state">
      <div class="big">&#9881;</div>
      <p>Loading working agreements...</p>
    </div>
  </div>
</div>

<script>
// ─── SVG Icons for Agent Avatars ─────────────────────────────────
// Each icon is an SVG path string drawn in a 24x24 viewBox
const AGENT_ICONS = {
  "engine-architect": // Gear
    '<path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7zm7.43-2.53l1.57-.27V11.3l-1.57-.27a7.04 7.04 0 0 0-.6-1.46l.93-1.27-1.06-1.06-1.27.93a7.04 7.04 0 0 0-1.46-.6L16.7 6h-1.4l-.27 1.57a7.04 7.04 0 0 0-1.46.6l-1.27-.93-1.06 1.06.93 1.27a7.04 7.04 0 0 0-.6 1.46L10 11.3v1.4l1.57.27c.14.52.34 1.01.6 1.46l-.93 1.27 1.06 1.06 1.27-.93c.45.26.94.46 1.46.6L15.3 18h1.4l.27-1.57a7.04 7.04 0 0 0 1.46-.6l1.27.93 1.06-1.06-.93-1.27c.26-.45.46-.94.6-1.46z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>',
  "game-designer": // Gamepad
    '<path d="M6 11h4M8 9v4M15 12h.01M18 10h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M17.32 5H6.68a2 2 0 0 0-1.95 1.55L3 14a3 3 0 0 0 5.83 1l.34-1h5.66l.34 1A3 3 0 0 0 21 14l-1.73-7.45A2 2 0 0 0 17.32 5z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>',
  "xp-coach": // Clipboard with check
    '<path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2" fill="none" stroke="currentColor" stroke-width="1.5"/><rect x="9" y="3" width="6" height="4" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/><path d="M9 14l2 2 4-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>',
  "devops-engineer": // Wrench
    '<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>',
  "qa-lead": // Magnifying glass with bug
    '<circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="1.5"/><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="2.5" fill="none" stroke="currentColor" stroke-width="1.2"/><path d="M11 8.5v-1M9 10h-1M13 10h1M11 13.5v1" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>',
  "level-designer": // Grid/Map
    '<rect x="3" y="3" width="18" height="18" rx="2" fill="none" stroke="currentColor" stroke-width="1.5"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18" stroke="currentColor" stroke-width="1" opacity="0.6"/><path d="M6 6l3 3M15 6l3 3M6 15l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>',
  "art-director": // Palette
    '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-1 0-.83.67-1.5 1.5-1.5H16c3.31 0 6-2.69 6-6 0-4.97-4.48-9-10-9z" fill="none" stroke="currentColor" stroke-width="1.5"/><circle cx="7.5" cy="11.5" r="1.5" fill="currentColor"/><circle cx="10.5" cy="7.5" r="1.5" fill="currentColor"/><circle cx="14.5" cy="7.5" r="1.5" fill="currentColor"/><circle cx="17.5" cy="11.5" r="1.5" fill="currentColor"/>',
  "sound-engineer": // Waveform
    '<path d="M12 3v18M8 7v10M4 10v4M16 7v10M20 10v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>',
  "team-lead": // Crown/Star
    '<path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 16.8l-6.2 4.5 2.4-7.4L2 9.4h7.6z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>',
  "user": // Person
    '<circle cx="12" cy="8" r="4" fill="none" stroke="currentColor" stroke-width="1.5"/><path d="M20 21a8 8 0 0 0-16 0" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>',
};
// Fallback for unknown agents
const FALLBACK_ICON = '<circle cx="12" cy="12" r="6" fill="none" stroke="currentColor" stroke-width="1.5"/><text x="12" y="15" text-anchor="middle" font-size="8" fill="currentColor">?</text>';

// ─── Agent Definitions ───────────────────────────────────────────
const AGENTS = {
  "engine-architect": { initials: "EA", color: "#10B981", label: "Engine Architect", role: "C++ Systems" },
  "game-designer":    { initials: "GD", color: "#F59E0B", label: "Game Designer",    role: "Mechanics" },
  "xp-coach":         { initials: "XP", color: "#3B82F6", label: "XP Coach",         role: "Process" },
  "devops-engineer":  { initials: "DE", color: "#8B5CF6", label: "DevOps Engineer",  role: "Build & CI" },
  "qa-lead":          { initials: "QA", color: "#06B6D4", label: "QA Lead",           role: "Quality" },
  "level-designer":   { initials: "LD", color: "#EF4444", label: "Level Designer",   role: "Spatial" },
  "art-director":     { initials: "AD", color: "#EC4899", label: "Art Director",     role: "Visuals" },
  "sound-engineer":   { initials: "SE", color: "#F97316", label: "Sound Engineer",   role: "Audio" },
  "team-lead":        { initials: "TL", color: "#6366F1", label: "Team Lead",        role: "Coordinator" },
  "user":             { initials: "U",  color: "#94A3B8", label: "Stakeholder",      role: "Direction" },
};

// ─── State ───────────────────────────────────────────────────────
const state = {
  transcripts: [],
  current: null,
  messages: [],
  index: -1,
  playing: false,
  speed: 1,
  baseDelay: 2500,
  animFrame: null,
  timeout: null,
  agentNodes: {},
  agentPositions: {},
  participants: [],
};

// ─── Canvas Setup ────────────────────────────────────────────────
const canvas = document.getElementById('arena-canvas');
const ctx = canvas.getContext('2d');
let dpr = window.devicePixelRatio || 1;

function resizeCanvas() {
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  if (state.current) layoutAgents();
}
window.addEventListener('resize', resizeCanvas);

// ─── Default GitHub Source ────────────────────────────────────────
const DEFAULT_SOURCES = [
  {
    owner: 'Randroids-Dojo',
    repo: 'UnrealFrog',
    path: '.claude/transcripts',
    ref: '39db5cc3ed7076b46cc0660d58e70aa1f0304556',
  },
];

// ─── GitHub Fetching ─────────────────────────────────────────────
async function listGitHubFiles(source) {
  const url = `https://api.github.com/repos/${source.owner}/${source.repo}/contents/${source.path}?ref=${source.ref}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`GitHub API ${resp.status}: ${resp.statusText}`);
  const items = await resp.json();
  return items.filter(f => f.name.endsWith('.md')).map(f => f.path);
}

async function fetchRawFile(source, filepath) {
  const url = `https://raw.githubusercontent.com/${source.owner}/${source.repo}/${source.ref}/${filepath}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`Fetch failed: ${resp.status}`);
  return resp.text();
}

// ─── Session Merging ─────────────────────────────────────────────
function mergeSession(transcripts) {
  const primary = transcripts.reduce((a, b) => a.messageCount > b.messageCount ? a : b);
  const meta = Object.assign({}, primary.metadata);

  const allParticipants = new Set();
  for (const t of transcripts) {
    for (const p of t.participants) allParticipants.add(p);
  }

  const merged = [];
  for (let fi = 0; fi < transcripts.length; fi++) {
    const t = transcripts[fi];
    for (let mi = 0; mi < t.messages.length; mi++) {
      merged.push({ time: t.messages[mi].time, fi, mi, msg: t.messages[mi] });
    }
  }
  merged.sort((a, b) => a.time < b.time ? -1 : a.time > b.time ? 1 : a.fi - b.fi || a.mi - b.mi);

  const sessionId = meta.sessionId || primary.id;
  return {
    id: sessionId,
    title: primary.title,
    metadata: meta,
    messages: merged.map(m => m.msg),
    participants: [...allParticipants].sort(),
    messageCount: merged.length,
    fileCount: transcripts.length,
  };
}

function groupAndMergeSessions(transcripts) {
  const bySession = {};
  for (const t of transcripts) {
    const sid = t.metadata?.sessionId || t.id;
    if (!bySession[sid]) bySession[sid] = [];
    bySession[sid].push(t);
  }
  const sessions = Object.values(bySession).map(group => mergeSession(group));
  sessions.sort((a, b) => {
    const da = a.metadata?.date || '', db = b.metadata?.date || '';
    return da > db ? -1 : da < db ? 1 : a.id > b.id ? -1 : 1;
  });
  return sessions;
}

// ─── Data Loading ────────────────────────────────────────────────
function setLoadingStatus(text) {
  const sel = document.getElementById('transcript-select');
  sel.innerHTML = '<option value="">-- ' + text + ' --</option>';
}

async function loadFromGitHub(sources) {
  const allTranscripts = [];

  for (const source of sources) {
    const label = source.owner + '/' + source.repo;
    setLoadingStatus('Listing files from ' + label + '...');

    let files;
    try {
      files = await listGitHubFiles(source);
    } catch (e) {
      console.error('Failed to list files from ' + label + ':', e);
      continue;
    }

    setLoadingStatus('Downloading ' + files.length + ' transcripts from ' + label + '...');

    // Fetch in batches to avoid overwhelming the browser
    const BATCH = 15;
    let done = 0;
    for (let i = 0; i < files.length; i += BATCH) {
      const batch = files.slice(i, i + BATCH);
      const results = await Promise.allSettled(
        batch.map(f => fetchRawFile(source, f).then(content => ({ name: f.split('/').pop().replace('.md', ''), content })))
      );
      for (const r of results) {
        if (r.status !== 'fulfilled') continue;
        try {
          const t = parseTranscriptMd(r.value.content, r.value.name + '.md');
          // Extract metadata (date, sessionId) that parseTranscriptMd doesn't capture
          t.metadata = parseMetadata(r.value.content);
          const hasTeammate = t.messages.some(m => m.type === 'teammate' || m.type === 'idle');
          if (hasTeammate && t.messages.length > 0) {
            allTranscripts.push(t);
          }
        } catch (e) {
          console.error('Parse error:', r.value.name, e);
        }
      }
      done += batch.length;
      setLoadingStatus('Downloaded ' + done + ' / ' + files.length + '...');
    }
  }

  return allTranscripts;
}

function parseMetadata(content) {
  const meta = {};
  const patterns = [
    ['date',      /\| Date \| (\d{4}-\d{2}-\d{2}) \|/],
    ['sessionId', /\| Session ID \| `([^`]+)` \|/],
    ['model',     /\| Model \| ([^|]+) \|/],
    ['duration',  /\| Duration \| ([^|]+) \|/],
    ['tokens',    /\| Tokens \| ([^|]+) \|/],
  ];
  for (const [key, re] of patterns) {
    const m = content.match(re);
    if (m) meta[key] = m[1].trim();
  }
  return meta;
}

async function loadData() {
  try {
    setLoadingStatus('Loading transcripts from GitHub...');
    const transcripts = await loadFromGitHub(DEFAULT_SOURCES);
    if (transcripts.length > 0) {
      state.transcripts = groupAndMergeSessions(transcripts);
      populateSelector();
      document.getElementById('drop-zone').classList.add('hidden');
      return;
    }
  } catch (e) {
    console.error('GitHub load failed:', e);
  }

  // Fallback: try local data file
  try {
    const resp = await fetch('data/transcripts.json');
    if (resp.ok) {
      const data = await resp.json();
      if (data.agents) Object.assign(AGENTS, data.agents);
      state.transcripts = data.transcripts || [];
      populateSelector();
      if (state.transcripts.length > 0) {
        document.getElementById('drop-zone').classList.add('hidden');
        return;
      }
    }
  } catch {}

  document.getElementById('drop-zone').classList.remove('hidden');
  setLoadingStatus('No transcripts loaded');
}

function populateSelector() {
  const sel = document.getElementById('transcript-select');
  sel.innerHTML = '<option value="">-- Select session (' + state.transcripts.length + ') --</option>';
  for (const t of state.transcripts) {
    const opt = document.createElement('option');
    opt.value = t.id;
    const date = t.metadata?.date || '';
    const msgs = t.messageCount || 0;
    const files = t.fileCount || 1;
    const agents = (t.participants || []).filter(p => p in AGENTS && p !== 'team-lead' && p !== 'user' && p !== 'system').length;
    opt.textContent = date + ' \u2014 ' + t.title + ' (' + msgs + ' msgs, ' + agents + ' agents)';
    sel.appendChild(opt);
  }
  sel.onchange = () => {
    const t = state.transcripts.find(x => x.id === sel.value);
    if (t) loadTranscript(t);
  };
}

// ─── File Drop/Upload ────────────────────────────────────────────
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

document.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
document.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
document.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', () => handleFiles(fileInput.files));

function handleFiles(files) {
  for (const file of files) {
    const reader = new FileReader();
    reader.onload = e => {
      const text = e.target.result;
      if (file.name.endsWith('.json')) {
        try {
          const data = JSON.parse(text);
          const list = data.transcripts || [data];
          state.transcripts.push(...list);
          populateSelector();
          dropZone.classList.add('hidden');
        } catch {}
      } else {
        const t = parseTranscriptMd(text, file.name);
        if (t && t.messages.length > 0) {
          state.transcripts.push(t);
          populateSelector();
          dropZone.classList.add('hidden');
        }
      }
    };
    reader.readAsText(file);
  }
}

function parseTranscriptMd(text, filename) {
  const messages = [];
  const sections = text.split(/^(## (?:User|Assistant) \(\d{2}:\d{2} UTC\))/m);
  let lastTeammate = null;

  for (let i = 1; i < sections.length; i += 2) {
    const header = sections[i];
    const body = sections[i + 1] || '';
    const hm = header.match(/## (User|Assistant) \((\d{2}:\d{2}) UTC\)/);
    if (!hm) continue;
    const [, role, time] = hm;

    const tm = body.match(/<teammate-message\s+teammate_id="([^"]+)"(?:\s+color="[^"]*")?(?:\s+summary="([^"]*)")?\s*>/);

    if (role === 'User' && tm) {
      const sender = tm[1], summary = tm[2] || '';
      const cm = body.match(/<teammate-message[^>]*>([\s\S]*?)<\/teammate-message>/);
      const content = cm ? cm[1].trim() : body.trim();
      let receiver = 'team-lead';
      const toM = summary.match(/\[to\s+([a-z][\w-]*)\]/i);
      if (toM) receiver = toM[1];
      const mtype = content.includes('"type": "idle_notification"') ? 'idle' : 'teammate';
      messages.push({ time, from: sender, to: receiver, content: content.slice(0, 800), summary, type: mtype });
      lastTeammate = sender;
    } else if (role === 'User') {
      const content = body.trim();
      if (content.length > 10) {
        messages.push({ time, from: 'user', to: 'team-lead', content: content.slice(0, 800), summary: '', type: 'user' });
        lastTeammate = null;
      }
    } else if (role === 'Assistant') {
      const lines = body.split('\n').filter(l => l.trim() && !l.trim().startsWith('- **Used'));
      if (lines.length > 0) {
        const receiver = lastTeammate || 'all';
        const mtype = body.includes('**Used SendMessage**') ? 'send' : 'response';
        messages.push({ time, from: 'team-lead', to: receiver, content: lines.join('\n').slice(0, 800), summary: '', type: mtype });
      }
    }
  }

  const name = filename.replace('.md', '');
  const participants = [...new Set(messages.flatMap(m => [m.from, ...(m.to !== 'all' ? [m.to] : [])]))];
  return {
    id: name, title: name.split('-').slice(4).join(' ') || name,
    metadata: {}, messages, participants, messageCount: messages.length, fileCount: 1
  };
}

// ─── Load Session ────────────────────────────────────────────────
function loadTranscript(t) {
  stop();
  state.current = t;
  state.messages = t.messages;
  state.index = -1;

  // Build participant list: include known agents + create entries for unknown ones
  const knownAgents = new Set(Object.keys(AGENTS));
  state.participants = [];
  for (const p of t.participants) {
    if (p === 'system') continue; // skip system messages
    if (!knownAgents.has(p)) {
      // Auto-register unknown agents with a generated color
      AGENTS[p] = {
        initials: p.slice(0, 2).toUpperCase(),
        color: '#' + Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0'),
        label: p.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
        role: 'Agent'
      };
    }
    state.participants.push(p);
  }

  // Ensure team-lead is included if any teammate messages exist
  if (state.messages.some(m => m.type === 'teammate' || m.type === 'response') && !state.participants.includes('team-lead')) {
    state.participants.push('team-lead');
  }

  // Update session info
  const info = document.getElementById('session-info');
  const agentCount = state.participants.filter(p => p !== 'user' && p !== 'system').length;
  info.textContent = agentCount + ' agents \u00B7 ' + t.messageCount + ' messages' + (t.fileCount > 1 ? ' \u00B7 ' + t.fileCount + ' threads merged' : '');

  layoutAgents();
  renderMessageList();
  updateUI();
  clearCanvas();
}

// ─── Create SVG Avatar ───────────────────────────────────────────
function createAvatarSVG(agentId) {
  const iconSvg = AGENT_ICONS[agentId] || FALLBACK_ICON;
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('viewBox', '0 0 24 24');
  svg.setAttribute('fill', 'none');
  svg.innerHTML = iconSvg;
  return svg;
}

// ─── Layout Agents in Circle ─────────────────────────────────────
function layoutAgents() {
  Object.values(state.agentNodes).forEach(n => n.remove());
  state.agentNodes = {};
  state.agentPositions = {};

  const wrap = document.getElementById('arena-wrap');
  const rect = wrap.getBoundingClientRect();
  const cx = rect.width / 2;
  const cy = rect.height / 2;
  const radius = Math.min(cx, cy) * 0.62;

  const display = state.participants.filter(a => a !== 'system');
  const count = display.length;

  display.forEach((id, i) => {
    const angle = (i / count) * Math.PI * 2 - Math.PI / 2;
    const x = cx + Math.cos(angle) * radius;
    const y = cy + Math.sin(angle) * radius;
    state.agentPositions[id] = { x, y };

    const agent = AGENTS[id] || { initials: '?', color: '#666', label: id, role: '' };
    const node = document.createElement('div');
    node.className = 'agent-node';
    node.style.left = x + 'px';
    node.style.top = y + 'px';
    node.style.setProperty('--agent-color', agent.color);
    node.dataset.agentId = id;

    const avatar = document.createElement('div');
    avatar.className = 'agent-avatar';
    avatar.style.background = agent.color + '22';
    avatar.style.borderColor = agent.color + '66';
    avatar.style.color = agent.color;
    avatar.appendChild(createAvatarSVG(id));

    const label = document.createElement('div');
    label.className = 'agent-label';
    label.textContent = agent.label;

    const role = document.createElement('div');
    role.className = 'agent-role';
    role.textContent = agent.role;

    node.appendChild(avatar);
    node.appendChild(label);
    node.appendChild(role);
    wrap.appendChild(node);
    state.agentNodes[id] = node;
  });
}

// ─── Canvas Drawing ──────────────────────────────────────────────
function clearCanvas() {
  const rect = canvas.parentElement.getBoundingClientRect();
  ctx.clearRect(0, 0, rect.width, rect.height);
}

function getControlPoint(from, to, cx, cy) {
  const mx = (from.x + to.x) / 2;
  const my = (from.y + to.y) / 2;
  const pull = 0.35;
  return { x: mx + (cx - mx) * pull, y: my + (cy - my) * pull };
}

function drawSelfLoop(pos, progress, color) {
  const rect = canvas.parentElement.getBoundingClientRect();
  clearCanvas();

  // Draw a loop that goes out from the agent and comes back
  const loopRadius = 40;
  const cx = rect.width / 2, cy = rect.height / 2;
  // Direction away from center
  const dx = pos.x - cx, dy = pos.y - cy;
  const dist = Math.sqrt(dx * dx + dy * dy) || 1;
  const nx = dx / dist, ny = dy / dist;
  const loopCx = pos.x + nx * loopRadius;
  const loopCy = pos.y + ny * loopRadius;

  // Full loop outline (faint)
  ctx.beginPath();
  ctx.arc(loopCx, loopCy, loopRadius, 0, Math.PI * 2);
  ctx.strokeStyle = color + '18';
  ctx.lineWidth = 2;
  ctx.stroke();

  if (progress > 0) {
    // Animated arc
    const startAngle = Math.atan2(pos.y - loopCy, pos.x - loopCx);
    const endAngle = startAngle + Math.PI * 2 * progress;
    ctx.beginPath();
    ctx.arc(loopCx, loopCy, loopRadius, startAngle, endAngle);
    ctx.strokeStyle = color;
    ctx.lineWidth = 2.5;
    ctx.shadowColor = color;
    ctx.shadowBlur = 8;
    ctx.stroke();
    ctx.shadowBlur = 0;

    // Dot at leading edge
    const dotX = loopCx + Math.cos(endAngle) * loopRadius;
    const dotY = loopCy + Math.sin(endAngle) * loopRadius;
    ctx.beginPath();
    ctx.arc(dotX, dotY, 5, 0, Math.PI * 2);
    ctx.fillStyle = '#fff';
    ctx.shadowColor = color;
    ctx.shadowBlur = 12;
    ctx.fill();
    ctx.shadowBlur = 0;
  }
}

function drawArc(fromPos, toPos, progress, color) {
  // Self-message: draw a loop
  if (fromPos === toPos || (fromPos.x === toPos.x && fromPos.y === toPos.y)) {
    drawSelfLoop(fromPos, progress, color);
    return;
  }

  const rect = canvas.parentElement.getBoundingClientRect();
  const cx = rect.width / 2, cy = rect.height / 2;
  const cp = getControlPoint(fromPos, toPos, cx, cy);

  clearCanvas();

  // Arc trail (faint)
  ctx.beginPath();
  ctx.moveTo(fromPos.x, fromPos.y);
  ctx.quadraticCurveTo(cp.x, cp.y, toPos.x, toPos.y);
  ctx.strokeStyle = color + '18';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Animated portion
  if (progress > 0) {
    const steps = 60;
    const endStep = Math.floor(progress * steps);
    ctx.beginPath();
    for (let s = 0; s <= endStep; s++) {
      const t = s / steps;
      const x = (1 - t) * (1 - t) * fromPos.x + 2 * (1 - t) * t * cp.x + t * t * toPos.x;
      const y = (1 - t) * (1 - t) * fromPos.y + 2 * (1 - t) * t * cp.y + t * t * toPos.y;
      if (s === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    }
    ctx.strokeStyle = color;
    ctx.lineWidth = 2.5;
    ctx.shadowColor = color;
    ctx.shadowBlur = 8;
    ctx.stroke();
    ctx.shadowBlur = 0;

    // Dot at leading edge
    const t = progress;
    const dotX = (1 - t) * (1 - t) * fromPos.x + 2 * (1 - t) * t * cp.x + t * t * toPos.x;
    const dotY = (1 - t) * (1 - t) * fromPos.y + 2 * (1 - t) * t * cp.y + t * t * toPos.y;
    ctx.beginPath();
    ctx.arc(dotX, dotY, 5, 0, Math.PI * 2);
    ctx.fillStyle = '#fff';
    ctx.shadowColor = color;
    ctx.shadowBlur = 12;
    ctx.fill();
    ctx.shadowBlur = 0;
  }
}

// ─── Speech Bubble ───────────────────────────────────────────────
const bubble = document.getElementById('speech-bubble');

function showBubble(msg, receiverPos) {
  if (!receiverPos) { hideBubble(); return; }
  const agent = AGENTS[msg.from];
  bubble.querySelector('.bubble-from').textContent = agent?.label || msg.from;
  bubble.querySelector('.bubble-from').style.color = agent?.color || '#fff';

  const text = msg.summary || msg.content.slice(0, 160);
  bubble.querySelector('.bubble-text').textContent = text + (msg.content.length > 160 && !msg.summary ? '...' : '');

  const wrap = document.getElementById('arena-wrap').getBoundingClientRect();
  const cx = wrap.width / 2, cy = wrap.height / 2;
  const dx = cx - receiverPos.x, dy = cy - receiverPos.y;
  const dist = Math.sqrt(dx * dx + dy * dy) || 1;
  const offsetX = (dx / dist) * 70;
  const offsetY = (dy / dist) * 70;

  bubble.style.left = (receiverPos.x + offsetX) + 'px';
  bubble.style.top = (receiverPos.y + offsetY) + 'px';
  bubble.style.borderColor = agent?.color || '#334155';
  bubble.classList.add('visible');
}

function hideBubble() {
  bubble.classList.remove('visible');
}

// ─── Animation ───────────────────────────────────────────────────
function animateMessage(index) {
  const msg = state.messages[index];
  if (!msg) return;

  state.index = index;
  updateUI();

  // Highlight sender/receiver
  Object.values(state.agentNodes).forEach(n => n.classList.remove('sender', 'receiver'));
  if (state.agentNodes[msg.from]) state.agentNodes[msg.from].classList.add('sender');
  const toId = msg.to === 'all' ? null : msg.to;
  if (toId && state.agentNodes[toId]) state.agentNodes[toId].classList.add('receiver');

  const fromPos = state.agentPositions[msg.from];
  const toPos = toId ? state.agentPositions[toId] : null;
  const color = AGENTS[msg.from]?.color || '#fff';

  // Self-message
  const isSelf = msg.from === msg.to || (toId && toId === msg.from);
  if (isSelf && fromPos) {
    const arcDuration = (state.baseDelay / state.speed) * 0.4;
    const startTime = performance.now();
    // Also mark as receiver for glow
    if (state.agentNodes[msg.from]) state.agentNodes[msg.from].classList.add('receiver');
    function frame(now) {
      const elapsed = now - startTime;
      const progress = Math.min(elapsed / arcDuration, 1);
      drawSelfLoop(fromPos, progress, color);
      if (progress >= 0.7 && !bubble.classList.contains('visible')) {
        showBubble(msg, fromPos);
      }
      if (progress < 1) {
        state.animFrame = requestAnimationFrame(frame);
      } else {
        showBubble(msg, fromPos);
        scheduleNext();
      }
    }
    cancelAnimationFrame(state.animFrame);
    clearTimeout(state.timeout);
    state.animFrame = requestAnimationFrame(frame);
    return;
  }

  if (!fromPos || !toPos) {
    clearCanvas();
    if (fromPos) showBubble(msg, fromPos);
    scheduleNext();
    return;
  }

  const arcDuration = (state.baseDelay / state.speed) * 0.4;
  const startTime = performance.now();

  function frame(now) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / arcDuration, 1);
    drawArc(fromPos, toPos, progress, color);

    if (progress >= 0.7 && !bubble.classList.contains('visible')) {
      showBubble(msg, toPos);
    }

    if (progress < 1) {
      state.animFrame = requestAnimationFrame(frame);
    } else {
      showBubble(msg, toPos);
      scheduleNext();
    }
  }

  cancelAnimationFrame(state.animFrame);
  clearTimeout(state.timeout);
  state.animFrame = requestAnimationFrame(frame);
}

function scheduleNext() {
  if (!state.playing) return;
  const holdDuration = (state.baseDelay / state.speed) * 0.6;
  state.timeout = setTimeout(() => {
    if (state.index < state.messages.length - 1) {
      animateMessage(state.index + 1);
    } else {
      stop();
    }
  }, holdDuration);
}

// ─── Playback Controls ──────────────────────────────────────────
function togglePlay() {
  if (state.playing) { pause(); } else { play(); }
}

function play() {
  if (!state.current || state.messages.length === 0) return;
  state.playing = true;
  document.getElementById('btn-play').textContent = 'Pause';
  document.getElementById('btn-play').classList.add('playing');
  const startIdx = state.index < 0 ? 0 : (state.index >= state.messages.length - 1 ? 0 : state.index + 1);
  animateMessage(startIdx);
}

function pause() {
  state.playing = false;
  cancelAnimationFrame(state.animFrame);
  clearTimeout(state.timeout);
  document.getElementById('btn-play').textContent = 'Play';
  document.getElementById('btn-play').classList.remove('playing');
}

function stop() {
  pause();
  hideBubble();
}

function stepNext() {
  pause();
  if (!state.current) return;
  const next = Math.min(state.index + 1, state.messages.length - 1);
  showMessageStatic(next);
}

function stepPrev() {
  pause();
  if (!state.current) return;
  const prev = Math.max(state.index - 1, 0);
  showMessageStatic(prev);
}

function showMessageStatic(index) {
  const msg = state.messages[index];
  if (!msg) return;
  state.index = index;

  Object.values(state.agentNodes).forEach(n => n.classList.remove('sender', 'receiver'));
  if (state.agentNodes[msg.from]) state.agentNodes[msg.from].classList.add('sender');
  const toId = msg.to === 'all' ? null : msg.to;
  if (toId && state.agentNodes[toId]) state.agentNodes[toId].classList.add('receiver');

  const fromPos = state.agentPositions[msg.from];
  const toPos = toId ? state.agentPositions[toId] : null;
  const color = AGENTS[msg.from]?.color || '#fff';

  const isSelf = msg.from === msg.to || (toId && toId === msg.from);
  if (isSelf && fromPos) {
    if (state.agentNodes[msg.from]) state.agentNodes[msg.from].classList.add('receiver');
    drawSelfLoop(fromPos, 1, color);
    showBubble(msg, fromPos);
  } else if (fromPos && toPos) {
    drawArc(fromPos, toPos, 1, color);
    showBubble(msg, toPos);
  } else if (fromPos) {
    clearCanvas();
    showBubble(msg, fromPos);
  } else {
    clearCanvas();
    hideBubble();
  }

  updateUI();
}

function jumpTo(index) {
  pause();
  showMessageStatic(index);
}

function updateSpeed() {
  const slider = document.getElementById('speed-slider');
  state.speed = parseFloat(slider.value);
  document.getElementById('speed-label').textContent = state.speed + 'x';
}

function handleTimelineClick(e) {
  if (!state.current || state.messages.length === 0) return;
  const rect = e.currentTarget.getBoundingClientRect();
  const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  const idx = Math.round(pct * (state.messages.length - 1));
  pause();
  showMessageStatic(idx);
}

// ─── UI Updates ──────────────────────────────────────────────────
function updateUI() {
  const total = state.messages.length;
  const idx = state.index;

  document.getElementById('counter-label').textContent = (idx >= 0 ? idx + 1 : 0) + ' / ' + total;
  document.getElementById('detail-counter').textContent = 'Message ' + (idx >= 0 ? idx + 1 : '-') + ' of ' + total;

  const pct = total > 0 && idx >= 0 ? ((idx / (total - 1)) * 100) : 0;
  document.getElementById('timeline-fill').style.width = pct + '%';
  document.getElementById('timeline-thumb').style.left = pct + '%';

  if (idx >= 0 && idx < total) {
    const msg = state.messages[idx];
    const fromAgent = AGENTS[msg.from];
    const toAgent = AGENTS[msg.to];
    const isSelf = msg.from === msg.to;

    document.getElementById('detail-time').textContent = msg.time + ' UTC';

    const routeEl = document.getElementById('detail-route');
    routeEl.innerHTML = '';
    const fromSpan = document.createElement('span');
    fromSpan.style.color = fromAgent?.color || '#fff';
    fromSpan.textContent = fromAgent?.label || msg.from;

    if (isSelf) {
      const selfBadge = document.createElement('span');
      selfBadge.style.cssText = 'font-size:10px;color:#a5b4fc;margin-left:8px;opacity:0.7;';
      selfBadge.textContent = '(self)';
      routeEl.append(fromSpan, selfBadge);
    } else {
      const arrow = document.createElement('span');
      arrow.className = 'arrow';
      arrow.textContent = ' \u2192 ';
      const toSpan = document.createElement('span');
      toSpan.style.color = toAgent?.color || '#fff';
      toSpan.textContent = msg.to === 'all' ? 'All' : (toAgent?.label || msg.to);
      routeEl.append(fromSpan, arrow, toSpan);
    }

    const typeEl = document.getElementById('detail-type');
    const typeColors = {
      teammate: '#10B981', response: '#6366F1', user: '#94A3B8',
      idle: '#475569', send: '#F59E0B'
    };
    typeEl.style.background = (typeColors[msg.type] || '#475569') + '33';
    typeEl.style.color = typeColors[msg.type] || '#94A3B8';
    typeEl.textContent = msg.type;

    document.getElementById('detail-content').textContent = msg.content;

    document.querySelectorAll('.msg-item').forEach((el, i) => {
      el.classList.toggle('active', i === idx);
    });
    const activeItem = document.querySelector('.msg-item.active');
    if (activeItem) activeItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  }
}

function renderMessageList() {
  const wrap = document.getElementById('msg-list-wrap');
  wrap.innerHTML = '';

  state.messages.forEach((msg, i) => {
    const item = document.createElement('div');
    item.className = 'msg-item';
    item.onclick = () => jumpTo(i);

    const dot = document.createElement('div');
    dot.className = 'msg-dot';
    dot.style.background = AGENTS[msg.from]?.color || '#666';

    const route = document.createElement('span');
    route.className = 'msg-item-route';
    const fromInit = AGENTS[msg.from]?.initials || '?';
    const isSelf = msg.from === msg.to;
    if (isSelf) {
      route.textContent = fromInit + '\u21BB'; // loop arrow
    } else {
      const toInit = msg.to === 'all' ? 'ALL' : (AGENTS[msg.to]?.initials || '?');
      route.textContent = fromInit + '\u2192' + toInit;
    }
    route.style.color = AGENTS[msg.from]?.color || '#fff';

    const summary = document.createElement('span');
    summary.className = 'msg-item-summary';
    summary.textContent = msg.summary || msg.content.slice(0, 60).replace(/\n/g, ' ');

    const time = document.createElement('span');
    time.className = 'msg-item-time';
    time.textContent = msg.time;

    item.append(dot, route, summary, time);
    if (isSelf) {
      const badge = document.createElement('span');
      badge.className = 'msg-self-badge';
      badge.textContent = 'self';
      item.insertBefore(badge, time);
    }
    wrap.appendChild(item);
  });
}

// ─── Keyboard Shortcuts ──────────────────────────────────────────
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  switch (e.key) {
    case ' ': e.preventDefault(); togglePlay(); break;
    case 'ArrowRight': case 'l': stepNext(); break;
    case 'ArrowLeft': case 'h': stepPrev(); break;
    case 'ArrowUp': case 'k':
      e.preventDefault();
      document.getElementById('speed-slider').stepUp();
      updateSpeed();
      break;
    case 'ArrowDown': case 'j':
      e.preventDefault();
      document.getElementById('speed-slider').stepDown();
      updateSpeed();
      break;
  }
});

// ─── View Navigation ─────────────────────────────────────────────
let currentView = 'replay';

function switchView(view) {
  currentView = view;
  document.querySelectorAll('.nav-tab').forEach((tab, i) => {
    tab.classList.toggle('active', ['replay', 'retros', 'agreement'][i] === view);
  });

  const replayView = document.getElementById('replay-view');
  const replayFooter = document.getElementById('replay-footer');
  const retrosView = document.getElementById('retros-view');
  const agreementView = document.getElementById('agreement-view');
  const transcriptSelect = document.getElementById('transcript-select');
  const sessionInfo = document.getElementById('session-info');

  replayView.classList.toggle('view-hidden', view !== 'replay');
  replayFooter.classList.toggle('view-hidden', view !== 'replay');
  retrosView.classList.toggle('view-hidden', view !== 'retros');
  agreementView.classList.toggle('view-hidden', view !== 'agreement');
  transcriptSelect.style.display = view === 'replay' ? '' : 'none';
  sessionInfo.style.display = view === 'replay' ? '' : 'none';

  if (view === 'replay') {
    resizeCanvas();
    if (state.current) layoutAgents();
  }
  if (view === 'retros' && !retroState.loaded) loadRetroData();
  if (view === 'agreement' && !agreementState.loaded) loadAgreementData();
}

// ─── Retros Data & Rendering ─────────────────────────────────────
const TEAM_SOURCE = {
  owner: 'Randroids-Dojo',
  repo: 'UnrealFrog',
  ref: 'main',
};

const retroState = {
  loaded: false,
  rawMarkdown: '',
  entries: [],
  commits: [],
};

const agreementState = {
  loaded: false,
  rawMarkdown: '',
  sections: [],
  commits: [],
};

async function fetchTeamFile(path) {
  const url = `https://raw.githubusercontent.com/${TEAM_SOURCE.owner}/${TEAM_SOURCE.repo}/${TEAM_SOURCE.ref}/.team/${path}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`Failed to fetch ${path}: ${resp.status}`);
  return resp.text();
}

async function fetchFileCommits(path) {
  const url = `https://api.github.com/repos/${TEAM_SOURCE.owner}/${TEAM_SOURCE.repo}/commits?path=.team/${path}&per_page=30`;
  const resp = await fetch(url);
  if (!resp.ok) return [];
  const data = await resp.json();
  return data.map(c => ({
    sha: c.sha.slice(0, 8),
    date: c.commit.committer.date.slice(0, 10),
    message: c.commit.message.split('\n')[0].slice(0, 100),
    fullSha: c.sha,
  }));
}

// ─── Parse Retrospective Log ─────────────────────────────────────
function parseRetroLog(markdown) {
  const entries = [];
  // Split on H2 headers
  const parts = markdown.split(/^(?=## )/m);

  for (const part of parts) {
    const headerMatch = part.match(/^## (.+)/);
    if (!headerMatch) continue;

    const title = headerMatch[1].trim();
    // Extract subsections
    const subsections = [];
    const subParts = part.split(/^(?=### )/m);

    for (const sp of subParts) {
      const subMatch = sp.match(/^### (.+)/);
      if (!subMatch) continue;
      subsections.push({
        title: subMatch[1].trim(),
        content: sp.replace(/^### .+\n/, '').trim(),
      });
    }

    // Determine the sprint number/type
    let sprintNum = null;
    let entryType = 'retro'; // retro, review, hotfix
    const retroNumMatch = title.match(/Retrospective\s+(\d+)/);
    if (retroNumMatch) sprintNum = parseInt(retroNumMatch[1]);
    if (title.includes('Stakeholder Review')) entryType = 'review';
    if (title.includes('Hotfix')) entryType = 'hotfix';
    if (title.includes('Strategic')) entryType = 'strategic';

    entries.push({
      title,
      sprintNum,
      entryType,
      subsections,
      rawContent: part.trim(),
    });
  }

  return entries;
}

function renderMarkdownContent(text) {
  // Basic markdown to HTML conversion for display
  let html = text
    // Code blocks (process first to protect from other transforms)
    .replace(/```[\s\S]*?```/g, m => {
      const code = m.replace(/```\w*\n?/, '').replace(/\n?```$/, '');
      return '<pre class="retro-code">' + escapeHtml(code) + '</pre>';
    })
    // Tables — wrap in scrollable container
    .replace(/^(\|.+\|)\n(\|[-| :]+\|)\n((?:\|.+\|\n?)*)/gm, (match, header, sep, rows) => {
      const headers = header.split('|').filter(c => c.trim()).map(c => `<th>${inlineMarkdown(c.trim())}</th>`).join('');
      const bodyRows = rows.trim().split('\n').filter(r => r.trim()).map(row => {
        const cells = row.split('|').filter(c => c.trim()).map(c => `<td>${inlineMarkdown(c.trim())}</td>`).join('');
        return `<tr>${cells}</tr>`;
      }).join('');
      return `<div class="retro-table-wrap"><table class="retro-table"><thead><tr>${headers}</tr></thead><tbody>${bodyRows}</tbody></table></div>`;
    })
    // Checkbox items
    .replace(/^- \[x\] (.+)$/gm, (_, t) => '<div class="retro-checkbox checked">' + inlineMarkdown(t) + '</div>')
    .replace(/^- \[~\] (.+)$/gm, (_, t) => '<div class="retro-checkbox partial">' + inlineMarkdown(t) + '</div>')
    .replace(/^- \[ \] (.+)$/gm, (_, t) => '<div class="retro-checkbox unchecked">' + inlineMarkdown(t) + '</div>')
    // Numbered lists with bold lead
    .replace(/^(\d+)\. \*\*(.+?)\*\*(.*)$/gm, (_, n, b, rest) => '<div class="retro-list-item"><span class="retro-list-num">' + n + '.</span> <strong>' + inlineMarkdown(b) + '</strong>' + inlineMarkdown(rest) + '</div>')
    // Numbered lists plain
    .replace(/^(\d+)\. (.+)$/gm, (_, n, t) => '<div class="retro-list-item"><span class="retro-list-num">' + n + '.</span> ' + inlineMarkdown(t) + '</div>')
    // Indented bullets (4 space)
    .replace(/^    - (.+)$/gm, (_, t) => '<div class="retro-bullet retro-indent2">' + inlineMarkdown(t) + '</div>')
    // Indented bullets (2-3 space)
    .replace(/^ {2,3}- (.+)$/gm, (_, t) => '<div class="retro-bullet retro-indent">' + inlineMarkdown(t) + '</div>')
    // Top-level bullets with bold
    .replace(/^- \*\*(.+?)\*\*(.*)$/gm, (_, b, rest) => '<div class="retro-bullet"><strong>' + inlineMarkdown(b) + '</strong>' + inlineMarkdown(rest) + '</div>')
    // Top-level bullets plain
    .replace(/^- (.+)$/gm, (_, t) => '<div class="retro-bullet">' + inlineMarkdown(t) + '</div>')
    // Remaining inline formatting
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    // Horizontal rules
    .replace(/^---+$/gm, '')
    // Paragraphs (remaining non-empty, non-HTML lines)
    .replace(/^(?!<|\s*$)(.+)$/gm, (_, t) => '<p>' + inlineMarkdown(t) + '</p>')
    // Remove empty paragraphs
    .replace(/<p>\s*<\/p>/g, '');

  return html;
}

function inlineMarkdown(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code>$1</code>');
}

function escapeHtml(text) {
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

async function loadRetroData() {
  const body = document.getElementById('retros-body');
  body.innerHTML = '<div class="empty-state"><div class="big">&#8635;</div><p>Loading retrospectives from GitHub...</p></div>';

  try {
    const [markdown, commits] = await Promise.all([
      fetchTeamFile('retrospective-log.md'),
      fetchFileCommits('retrospective-log.md'),
    ]);
    retroState.rawMarkdown = markdown;
    retroState.commits = commits;
    retroState.entries = parseRetroLog(markdown);
    retroState.loaded = true;

    // Populate sprint selector
    const sel = document.getElementById('retro-sprint-select');
    sel.innerHTML = '<option value="all">All Entries (' + retroState.entries.length + ')</option>';
    for (let i = 0; i < retroState.entries.length; i++) {
      const e = retroState.entries[i];
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = e.title;
      sel.appendChild(opt);
    }
    sel.onchange = () => renderRetros(sel.value);

    document.getElementById('retro-info').textContent = retroState.entries.length + ' entries \u00B7 ' + commits.length + ' commits';
    renderRetros('all');
  } catch (e) {
    console.error('Failed to load retro data:', e);
    body.innerHTML = '<div class="empty-state"><div class="big">!</div><p>Failed to load retrospectives: ' + e.message + '</p></div>';
  }
}

function renderRetros(filter) {
  const body = document.getElementById('retros-body');
  body.innerHTML = '';

  const entries = filter === 'all' ? retroState.entries : [retroState.entries[parseInt(filter)]];

  for (const entry of entries) {
    const card = document.createElement('div');
    card.className = 'retro-entry';

    // Type badge color
    const typeColors = {
      retro: '#10B981',
      review: '#F59E0B',
      hotfix: '#EF4444',
      strategic: '#8B5CF6',
    };
    const typeLabels = {
      retro: 'RETROSPECTIVE',
      review: 'STAKEHOLDER REVIEW',
      hotfix: 'HOTFIX',
      strategic: 'STRATEGIC REVIEW',
    };

    // Find associated commit
    const associatedCommit = retroState.commits.find(c => {
      const titleLower = entry.title.toLowerCase();
      const msgLower = c.message.toLowerCase();
      if (entry.sprintNum !== null && msgLower.includes('sprint ' + entry.sprintNum)) return true;
      if (titleLower.includes('hotfix') && msgLower.includes('hotfix')) return true;
      if (titleLower.includes('strategic') && msgLower.includes('strategic')) return true;
      return false;
    });

    // Start collapsed in "all" view to reduce scroll overwhelm
    const startCollapsed = filter === 'all';

    let headerHTML = `
      <div class="retro-entry-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <span class="collapse-icon">\u25BC</span>
        <span class="retro-entry-badge" style="background:${typeColors[entry.entryType]}22;color:${typeColors[entry.entryType]}">${typeLabels[entry.entryType]}</span>
        <h3 class="retro-entry-title">${entry.title}</h3>
        <span class="retro-entry-meta-count">${entry.subsections.length} sections</span>
        ${associatedCommit ? `<span class="retro-entry-commit" title="${associatedCommit.message}"><code>${associatedCommit.sha}</code> ${associatedCommit.date}</span>` : ''}
      </div>
    `;

    let sectionsHTML = '';
    for (const sub of entry.subsections) {
      // Assign visual category
      let sectionClass = 'neutral';
      const titleLower = sub.title.toLowerCase();
      if (titleLower.includes('went well') || titleLower.includes('what was built')) sectionClass = 'positive';
      if (titleLower.includes('friction') || titleLower.includes('went wrong') || titleLower.includes('defects')) sectionClass = 'negative';
      if (titleLower.includes('action item') || titleLower.includes('agreements changed') || titleLower.includes('agreements to change')) sectionClass = 'action';
      if (titleLower.includes('stats') || titleLower.includes('burndown')) sectionClass = 'stats';
      if (titleLower.includes('open question') || titleLower.includes('resolved question')) sectionClass = 'question';
      if (titleLower.includes('feedback') || titleLower.includes('investigation')) sectionClass = 'negative';
      if (titleLower.includes('immediate fixes') || titleLower.includes('fixes applied')) sectionClass = 'action';

      sectionsHTML += `
        <div class="retro-section retro-section-${sectionClass}">
          <div class="retro-section-title">${sub.title}</div>
          <div class="retro-section-content">${renderMarkdownContent(sub.content)}</div>
        </div>
      `;
    }

    card.innerHTML = headerHTML + '<div class="retro-entry-sections">' + sectionsHTML + '</div>';
    if (startCollapsed) card.classList.add('collapsed');
    body.appendChild(card);
  }
}

// ─── Parse Working Agreements ────────────────────────────────────
function parseAgreements(markdown) {
  const sections = [];
  // Split on ### for numbered sections within Day 0 Agreements
  const parts = markdown.split(/^(?=### )/m);

  for (const part of parts) {
    const headerMatch = part.match(/^### (.+)/);
    if (!headerMatch) continue;

    const title = headerMatch[1].trim();
    const content = part.replace(/^### .+\n/, '').trim();

    // Extract the number and name
    const numMatch = title.match(/^(\d+\w?)\.\s*(.+)/);
    const number = numMatch ? numMatch[1] : null;
    const name = numMatch ? numMatch[2] : title;

    // Check for sprint update markers
    const updates = [];
    const updateRegex = /\((?:Updated|Added|New)(?::?\s*)?([^)]*(?:Sprint|Retrospective|Review|Hotfix)[^)]*)\)/gi;
    let m;
    while ((m = updateRegex.exec(content)) !== null) {
      updates.push(m[1].trim());
    }

    sections.push({
      number,
      name,
      title,
      content,
      updates,
    });
  }

  return sections;
}

async function loadAgreementData() {
  const body = document.getElementById('agreement-body');
  body.innerHTML = '<div class="empty-state"><div class="big">&#9881;</div><p>Loading working agreements from GitHub...</p></div>';

  try {
    const [markdown, commits] = await Promise.all([
      fetchTeamFile('agreements.md'),
      fetchFileCommits('agreements.md'),
    ]);
    agreementState.rawMarkdown = markdown;
    agreementState.commits = commits;
    agreementState.sections = parseAgreements(markdown);
    agreementState.loaded = true;

    // Populate version selector with commits
    const sel = document.getElementById('agreement-version-select');
    sel.innerHTML = '<option value="latest">Latest (' + commits.length + ' revisions)</option>';
    for (const c of commits) {
      const opt = document.createElement('option');
      opt.value = c.fullSha;
      opt.textContent = c.date + ' \u2014 ' + c.message.slice(0, 60);
      sel.appendChild(opt);
    }
    sel.onchange = () => {
      if (sel.value === 'latest') {
        renderAgreements(agreementState.sections, agreementState.commits);
      } else {
        loadAgreementVersion(sel.value);
      }
    };

    document.getElementById('agreement-info').textContent = agreementState.sections.length + ' sections \u00B7 ' + commits.length + ' revisions';
    renderAgreements(agreementState.sections, commits);
  } catch (e) {
    console.error('Failed to load agreement data:', e);
    body.innerHTML = '<div class="empty-state"><div class="big">!</div><p>Failed to load agreements: ' + e.message + '</p></div>';
  }
}

async function loadAgreementVersion(sha) {
  const body = document.getElementById('agreement-body');
  body.innerHTML = '<div class="empty-state"><div class="big">&#9881;</div><p>Loading version...</p></div>';
  try {
    const url = `https://raw.githubusercontent.com/${TEAM_SOURCE.owner}/${TEAM_SOURCE.repo}/${sha}/.team/agreements.md`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('Not found at this commit');
    const markdown = await resp.text();
    const sections = parseAgreements(markdown);
    renderAgreements(sections, agreementState.commits, sha);
  } catch (e) {
    body.innerHTML = '<div class="empty-state"><div class="big">!</div><p>Failed to load version: ' + e.message + '</p></div>';
  }
}

function renderAgreements(sections, commits, currentSha) {
  const body = document.getElementById('agreement-body');
  body.innerHTML = '';

  // Preamble
  if (currentSha) {
    const commit = commits.find(c => c.fullSha === currentSha);
    if (commit) {
      const note = document.createElement('div');
      note.className = 'agreement-version-note';
      note.innerHTML = `Viewing version from <strong>${commit.date}</strong>: <code>${commit.sha}</code> &mdash; ${commit.message}`;
      body.appendChild(note);
    }
  }

  for (const section of sections) {
    const el = document.createElement('div');
    el.className = 'agreement-section';

    // Determine icon
    const icons = {
      'collaboration': '\u{1F91D}',
      'tdd': '\u{1F9EA}',
      'communication': '\u{1F4AC}',
      'commit': '\u{1F4E6}',
      'feature workflow': '\u{1F500}',
      'definition of done': '\u2705',
      'asset': '\u{1F3A8}',
      'retrospective': '\u{1F504}',
      'playunreal': '\u{1F3AE}',
      'visual': '\u{1F441}',
      'scene': '\u{1F304}',
      'material': '\u{1F308}',
      'overlap': '\u{1F4CD}',
      'delegate': '\u{1F517}',
      'launch': '\u{1F680}',
      'platform': '\u{1F6A7}',
      'runtime': '\u26A1',
      'deferred': '\u23F0',
      'cross-domain': '\u{1F50D}',
      'one agent': '\u{1F512}',
      'position': '\u{1F4CF}',
      'auto-screenshot': '\u{1F4F8}',
      'constant': '\u{1F504}',
      'retro notes': '\u{1F4DD}',
      'sprint sequencing': '\u{1F4C5}',
      'webfrogger': '\u{1F438}',
    };

    let icon = '\u{1F4CB}';
    const nameLower = section.name.toLowerCase();
    for (const [key, value] of Object.entries(icons)) {
      if (nameLower.includes(key)) { icon = value; break; }
    }

    const updatesHTML = section.updates.length > 0
      ? `<div class="agreement-item-updates">${section.updates.map(u => `<span class="agreement-update-tag">${u}</span>`).join('')}</div>`
      : '';

    el.innerHTML = `
      <div class="agreement-item collapsed">
        <div class="agreement-item-icon">${icon}</div>
        <div class="agreement-item-content">
          <div class="agreement-item-header" onclick="this.closest('.agreement-item').classList.toggle('collapsed')">
            <span class="collapse-icon">\u25BC</span>
            <div class="agreement-item-text"><strong>${section.number ? '\u00A7' + section.number + ' ' : ''}${section.name}</strong></div>
          </div>
          <div class="agreement-item-detail">${renderMarkdownContent(section.content)}</div>
          ${updatesHTML}
        </div>
      </div>
    `;
    body.appendChild(el);
  }

  // Git history timeline
  if (commits.length > 0) {
    const timeline = document.createElement('div');
    timeline.className = 'agreement-git-timeline';
    timeline.innerHTML = `
      <div class="agreement-section-title" style="margin-bottom:12px">Evolution Timeline</div>
      ${commits.map((c, i) => `
        <div class="git-timeline-entry${c.fullSha === currentSha ? ' active' : ''}">
          <div class="git-timeline-dot"></div>
          <div class="git-timeline-line${i === commits.length - 1 ? ' last' : ''}"></div>
          <div class="git-timeline-content">
            <div class="git-timeline-date">${c.date}</div>
            <div class="git-timeline-msg">${c.message}</div>
            <div class="git-timeline-sha"><code>${c.sha}</code></div>
          </div>
        </div>
      `).join('')}
    `;
    body.appendChild(timeline);
  }

  // Last updated
  if (commits.length > 0) {
    const updated = document.createElement('div');
    updated.className = 'agreement-last-updated';
    updated.textContent = 'Last updated: ' + commits[0].date + ' \u00B7 ' + commits.length + ' total revisions';
    body.appendChild(updated);
  }
}

// ─── Init ────────────────────────────────────────────────────────
resizeCanvas();
loadData();
</script>
</body>
</html>
